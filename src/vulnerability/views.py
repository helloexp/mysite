from django.shortcuts import render_to_response
from django.contrib import auth
from django.http import HttpResponse, HttpResponseRedirect
from vulnerability.models import CVE, REUSE
from vulnerability.models import INFO
from vulnerability.models import FUNC
from django import forms
# from vulnerability.models import RegisterForm
from django.template import RequestContext
from django.db import connection
import re
from _datetime import datetime
PAGENUMS = 20

class PageIndex:
    def __init__(self):
        self.sum = 0
        self.curIndex = 0
        self.endIndex = 0
        self.lastPageIndex = 0
        self.firstPageNum = 1
        self.curPageNum = 1
        self.endPageNum = 1
        self.pages = range(self.curPageNum, self.curPageNum + 10)
        self.page = 1  # only for pages
        self.queryString = None
    def getPageIndex(self):  # from pages Num to Index
        index = (self.page - 1) * PAGENUMS
        self.page += 1
        return index
    def getEndIndex(self):
        endIndex = int(self.curIndex) + PAGENUMS - 1
        if endIndex > self.sum:
            return self.sum
        else:
            return endIndex
        
def display_meta(req):
    return render_to_response('add_vuln.html')
# Create your views here.

def index(req):
    return render_to_response('index.html' , {'user':req.user})

def vulnerability(req):
    errors = []
    try:
        sum1 = CVE.objects.count()
        pageInfo1 = pagination_vul(int(sum1), req)
        vulnerabilities = CVE.objects.all()[pageInfo1.curIndex - 1:pageInfo1.endIndex]
        for vuln in vulnerabilities:
            vuln.exploits = vuln.exploit_set.count()
        print(vulnerabilities)
        # vulnerabilities with patch
        
#         vulnerabilitiesWithPatch = []
#         funcs = FUNC.objects.all()
#         for func in funcs:
#             if func.info_id.cve not in vulnerabilitiesWithPatch:
#                 vulnerabilitiesWithPatch.append(func.info_id.cve)
#         sumPatch = len(vulnerabilitiesWithPatch)
#         print(vulnerabilitiesWithPatch)
#         pageInfoPatch = pagination_vul(int(sumPatch), req)
#         vulnerabilitiesWithPatchTemp = vulnerabilitiesWithPatch[pageInfoPatch.curIndex - 1:pageInfoPatch.endIndex]
#         for vuln in vulnerabilitiesWithPatchTemp:
#             vuln.exploits = vuln.exploit_set.count()
#         print(vulnerabilitiesWithPatchTemp)
        # vulnerabilities with reuse
        reuses = REUSE.objects.all()
        vulnerabilitiesWithReuse = []
        for reuse in reuses:
            if reuse.info_id.cve not in vulnerabilitiesWithReuse:
                vulnerabilitiesWithReuse.append(reuse.info_id.cve)
        sumReuse = len(vulnerabilitiesWithReuse)
        print("reuse")
        print(vulnerabilitiesWithReuse)
        pageInfoReuse = pagination_vul(int(sumReuse), req) 
        vulnerabilitiesWithReuseTemp = vulnerabilitiesWithReuse[pageInfoReuse.curIndex - 1:pageInfoReuse.endIndex]
        for vuln in vulnerabilitiesWithReuseTemp:
            vuln.exploits = vuln.exploit_set.count()
        print("reuse")
        print(vulnerabilitiesWithReuseTemp)
            
        return render_to_response('overview.html', {\
                                                    'vulnerabilitiesWithReuse':vulnerabilities, \
                                                    'user':req.user, \
                                                     'vulnerabilitiesWithPatch':vulnerabilities, \
                                                     'pageInfoPatch':pageInfo1, \
                                                     'pageInfoReuse':pageInfo1 \
                                                    })
    except Exception as err:
        errors.append(err)  
        return render_to_response('overview.html', {'errors': errors})
def searchAdvanced(req):
    
    return render_to_response('search_advanced.html')
    
def importBatch(req):
    return render_to_response('importBatch.html')

class UserForm(forms.Form):
    username = forms.CharField(max_length=20, label=u"username")
    password = forms.CharField(widget=forms.PasswordInput, max_length=20, label=u"password")
    
def login(req):
    
    if req.method == "POST":
        user_form = UserForm(req.POST)
        if user_form.is_valid():
            username = user_form.cleaned_data['username']
            password = user_form.cleaned_data['password']
            print ("valid")
            user = auth.authenticate(username=username, password=password)
            print("user")
            print(user)
            print(username + password)
            if user:
                print("password" + user.password)
                auth.login(req, user) 
                response = render_to_response("index.html", RequestContext(req))
                if 'next' in req.GET:
                        return HttpResponseRedirect(req.GET["next"])
                # 将username写入浏览器cookie,失效时间为3600
                return response
            else:
                return render_to_response("login.html", RequestContext(req, {'wrong':"wrong username or password"}))
        else:
            return render_to_response("login.html", RequestContext(req, {'wrong':"please input username and password"}))
    else:
        return render_to_response("login.html", RequestContext(req))
    

def logout(req):
    auth.logout(req)
    logout = "logout"
    return render_to_response("index.html", {'logout':logout}) 

class RegistrationForm(forms.Form):
    username = forms.CharField(label=u'username', max_length=100)
    password1 = forms.CharField(widget=forms.PasswordInput, max_length=20, label=u"password1")
    password2 = forms.CharField(widget=forms.PasswordInput, max_length=20, label=u"password2")
    email = forms.EmailField(label=u'email')
    
def registration(req):
    from django.contrib.auth.models import User
    if req.method == "POST":
        uf = RegistrationForm(req.POST)
        if uf.is_valid():
            # get form
            username = uf.cleaned_data['username']
            password1 = uf.cleaned_data['password1']
            password2 = uf.cleaned_data['password2']
            email = uf.cleaned_data['email']
            errors = []
            if password1 != password2:
                errors.append("Entered passwords differ!")
                return render_to_response('registration.html', RequestContext(req, {'uf':uf, 'errors':errors})) 
            
            filterResult = User.objects.filter(username=username)  #c************  
            if len(filterResult) > 0:  
                errors.append("A username already exists")  
                return render_to_response('registration.html', RequestContext(req, {'uf':uf, 'errors':errors})) 
            # install to mysql
            # user = User.objects.create(username,email,password2)
            user = User.objects.create_user(username, email, password2)
            user.save()
            # login
            # login_user=auth.authenticate(username=username, password=password1)
            # auth.login(req, login_user) 
            # 返回注册成功页面
            return render_to_response('success.html', RequestContext(req, {'tips':"Registration successful.Please login" + password2}))
        else:
            errors.append("Please input username、password and email")
            return render_to_response('registration.html', RequestContext(req, {'uf':uf, 'errors':errors}))    
    else:
        uf = RegistrationForm()
        return render_to_response('registration.html', context_instance=RequestContext(req, {'uf':uf}))

def forum(req):
    return render_to_response('forum.html', {'user':req.user})

def detail_vul(req):
    errors = []
    if 'q' in req.GET:
        q = req.GET['q']
        if not validCVE(q):
            errors.append('Enter a search term.')
        else:
            if not re.match('^CVE-', q):
                q = 'CVE-' + q
            query = q
            try:
                cves = CVE.objects.filter(cve_id=query)
            except:
                errors.append("No Term Found")
                return render_to_response('search.html', {'errors': errors})
            try:
                infos = INFO.objects.filter(cve=cves)
            except:
                errors.append("No INFO Found")
            try:
                files = []
                funcs = []
                
                for info in infos:
                    funcs.append(info.func_set.all())
                  #  func = FUNC.objects.filter(info_id=info)
                   # for fun1 in func:
                    #    file = fun1.vuln_file
                     #   if file in files:
                     #       continue                        
                      #  func = ""
                       # for fun2 in func:
                       #     if fun2.vuln_file == file:
                        #        if len(func) > 0:
                        #            func += ("," + fun2.vuln_func)
                        #        else:
                         #           func += fun2.vuln_func
                      #  file += ";"
                      #  func += ";"
                  #  files.append(file)
                  #  funcs.append(func)
            except:
                 errors.append("No FUNC Found")
                 
            return render_to_response('detail_vul.html',
                {'query':query, 'cves':cves, 'infos':infos, 'files':files, 'funcs':funcs})
    return render_to_response('search_result.html', {'errors': errors})

def validCVE(cveid):
    patt = '^(CVE-)?[0-9]{4}-[0-9]{1,39}$'
    m = re.match(patt, cveid)
    if not m:
        return False
    return True

def search_cve(req):
    errors = []
    query = []
    q = req.GET['q']
    if not q:
        errors.append('Enter a search term.')
    elif not validCVE(q):
        errors.append('Incorrect CVE ID, expected format: CVE-[0-9]{4}-[0-9]{1,39} or [0-9]{4}-[0-9]{1,39}')
    else:            
        query.append(q)
        try:
            vulnerabilities = CVE.objects.filter(cve_id__contains=q)
            for vuln in vulnerabilities:
                vuln.exploits = vuln.exploit_set.count()
            return render_to_response('search_results.html', {'vulnerabilities':vulnerabilities, 'user':req.user, 'q':q})
        except:
            errors.append("ERROR")
    return render_to_response('search_results.html', {'errors': errors, 'q':q, 'user':req.user})      

def search_vul(req):
    if 'q' in req.GET:  # search 
        return search_cve(req)
    elif 'ad_q' in req.GET:  # advanced search
        return search_advanced(req)
    # elif 'Analysis' in req.GET:  # analysis
    #    return analysis(req)
    else:
        return render_to_response('404.html') 

def search_advanced(req):
    errors = []
    query = []
    vulnerabilities = []
    cursor = connection.cursor()
    sql = "select * from vulnerability_cve"
    condition = None
    # CveIdentifier CveIdentifierTextBox
    CveIdentifier = req.GET['CveIdentifierTextBox']
    if CveIdentifier:
        if not validCVE(CveIdentifier):
            errors.append('Incorrect CVE ID, expected format: CVE-[0-9]{4}-[0-9]{1,39} or [0-9]{4}-[0-9]{1,39}')
        else:
            temp = "CVEID rlike '[CVE-]?" + CveIdentifier + "'" 
            condition = add_condition(condition, temp)
            query.append('CVEID:' + CveIdentifier)
    # Keyword QueryTextBox    
    keyword = req.GET['QueryTextBox']
    if keyword:
        if len(keyword) > 20:
            errors.append('Please submit keyword 20 characters or shorter')
        else:
            temp = "Description rlike '.*" + keyword + ".*'" 
            condition = add_condition(condition, temp)
            query.append('Description KeyWords:' + keyword)
            
    # cweid CweDropDownList    
    cweid = req.GET['CweDropDownList']
    if cweid != "":
        cweid = cweid[4:]
        if (cweid == "CWE-noinfo") or (cweid == 'CWE-Other'):
            temp = "cweid is null"
        else:
            temp = "CWEID = '" + cweid + "'"
            query.append('CWEID:' + "Get the CWE Value from ID is not done .we have no cwe dictionary yet")
        condition = add_condition(condition, temp)
        
    # Vendor CPEVendorTextBox
    vendor = req.GET['CPEVendorTextBox']
    if vendor:
        if len(vendor) > 20:
            errors.append('Please submit Vendor 20 characters or shorter')
        else:  # if has cpe then use cpe sql
            sql = "select * from vulnerability_cve"
            temp = "company= '" + vendor + "'"
            condition = add_condition(condition, temp)
            query.append('Vendor:' + vendor)
    # Product CPEProductTextBox
    product = req.GET['CPEProductTextBox']
    if product:
        if len(product) > 20:
            errors.append('Please submit Product 20 characters or shorter')
        else:  # if has cpe then use cpe sql
            sql = "select * from vulnerability_cve"
            temp = "name rlike '.*" + product + ".*'"
            condition = add_condition(condition, temp)
            query.append('Product:' + product)
    # version CPEVersionTextBox
    version = req.GET['CPEVersionTextBox']
    if version:
        if not product:
            errors.append('Version needs Product first')
        elif len(version) > 20:
            errors.append('Please submit Version 20 characters or shorter')
        else:
            sql = "select * from vulnerability_cve"
            temp = "SoftwareVersion = '" + version + "'"
            condition = add_condition(condition, temp)
            query.append('Version:' + version)
    # Modify date Range
    # startTime ModDateStartMonthDropDown ModDateStartYearDropDown
    flag = None
    month = req.GET['ModDateStartMonthDropDown']
    year = req.GET['ModDateStartYearDropDown']
    if month != "0" and year != "0":
        startTime = year + "-" + month.zfill(2) + "-01T00:00.000-00:00"
        temp = "update_date >= '" + startTime + "'"
        condition = add_condition(condition, temp)
        query.append('Modified Date Start Time:' + year + "-" + month.zfill(2))
    elif (month == '0' and year != '0') or (month != '0' and year == '0'):
        flag = 1
    # endTime  ModDateEndMonthDropDown ModDateEndYearDropDown
    month = req.GET['ModDateEndMonthDropDown']
    year = req.GET['ModDateEndYearDropDown']
    if month != "0" and year != "0":
        endTime = year + "-" + month.zfill(2) + "-31T23:59.999-23:59"
        temp = "update_date <= '" + endTime + "'"
        condition = add_condition(condition, temp)
        query.append('Modified Date End Time:' + year + "-" + month.zfill(2))
    elif (month == '0' and year != '0') or (month != '0' and year == '0'):
        flag = 1 
    if flag != None:
        errors.append('Any dates chosen must select both Month and Year')
    # CVSS 
    # CvssSevBaseDropDown
    res = req.GET['CvssSevBaseDropDown']
    if res != "":
        if res == "LOW":
            low = 0
            high = 3
        elif res == "MEDIUM":
            low = 4
            high = 6
        elif res == "MEDIUM_HIGH":
            low = 4
            high = 10
        elif res == "HIGH":
            low = 7
            high = 10
        temp = "CVSS >= '%s' and CVSS <= '%s'" % (low, high)
        condition = add_condition(condition, temp)
        query.append('Severity (Base Score Range):' + str(res))
    
    if errors:
        return render_to_response('search_advanced.html', {'errors': errors})
    if condition:
        sql = sql + " where " + condition + " order by CVEID DESC"
    try:
        sql += ";"
        print(sql)
        cursor.execute(sql)
        # get data
        desc = cursor.description
        rows = [ dict(zip([col[0] for col in desc], row)) for row in cursor.fetchall()]
        print(rows)
        # page nums
        sum1 = len(rows)
        print(sum1)
        pageInfo = pagination_vul(sum1, req)
        print('page')
        print(pageInfo.curIndex)
        print(pageInfo.endIndex)
        print(rows)
        rows = rows[pageInfo.curIndex - 1:pageInfo.endIndex]
        print(rows)
        print('3')
        for row in rows:
            vulnTemp = CVE     
            vulnTemp.cve_id = row['CVEID']
            print(vulnTemp.cve_id)
            vulnTemp.user = row['User']
            vulnTemp.cwe_id = row['CWEID']
            vulnTemp.cvss_id = row['CVSS']
            vulnTemp.update_date = row['update_date']
            vulnTemp.description = row['Description']
            vulnTemp.vuln_type = row['TYPE']
            vulnerabilities.append(vulnTemp)
        print('4')
        return render_to_response('search_results.html',
            {'vulnerabilities':vulnerabilities, 'q':query, 'pageInfo':pageInfo})
    except:
        errors.append('Execute sql error')
    finally:
        cursor.close()
    return render_to_response('search_advanced.html', {'errors': errors})

def add_condition(condition, str):
    if condition:
        str = " and " + str 
        condition += str
    else:
        condition = str
    return condition

def add_Save(req):
    curtime = datetime.now()
    errors = []
    if req.method == 'GET':  
        print("GET")  
        cve_id = req.GET['cve_id']
        cwe_id = req.GET['cwe_id']
        vuln_type = req.GET['vuln_type']
        cvss_id = req.GET['cvss_id']
        description = req.GET['description']
        user = req.GET['user']
        cveResult = CVE.objects.filter(cve_id=cve_id)
        if len(cveResult) > 0:
            errors.append("cve exists")
            return render_to_response('add_success.html', {'errors':errors})
        cve = CVE()
        cve.cve_id = cve_id
        cve.cwe_id = cwe_id
        cve.vuln_type = vuln_type
        cve.cvss_id = cvss_id
        cve.description = description
        cve.user = user
        cve.update_date = curtime
        cve.save()
    return render_to_response('add_success.html', {'errors':errors})

def pagination_vul(sum1, req):
    try:
        errors = []
        # page index info
        pageInfo = PageIndex()
        pageInfo.sum = sum1
        pageInfo.endPageNum = sum1 / PAGENUMS + 1
        # query string  
        if 'QUERY_STRING' in req.META:
            queryString = req.META['QUERY_STRING']
            re.sub('&startIndex.*$', '', queryString)
            pageInfo.queryString = queryString
        startIndex = 0
        if 'startIndex' in req.GET:
            startIndex = int(req.GET['startIndex'])  ###########take care of req
        pageInfo.curIndex = startIndex + 1  # page index start from 1,so it needs +1 there  
        pageInfo.endIndex = pageInfo.getEndIndex()
        if sum1 > PAGENUMS:
            pageInfo.lastPageIndex = sum1 - sum1 % PAGENUMS
        else:
            pageInfo.lastPageIndex = 0
        # page num info
        firstPageNum = 1
        print("test1")
        if 'firstPageNum' in req.GET:
            firstPageNum = int(req.GET['firstPageNum'])
        lastPageNum = firstPageNum + 9
        if lastPageNum > pageInfo.endPageNum:
            lastPageNum = pageInfo.endPageNum
        print("test2")
        pageInfo.curPageNum = startIndex / PAGENUMS + 1
        print("test31")
        pageInfo.pages = range(firstPageNum, lastPageNum + 1)
        print("test32")
        if pageInfo.curPageNum == lastPageNum:  # and pageInfo.curPageNum != pageInfo.endPageNum:#the last pageNum adjust nav bar
            lastPageNum = pageInfo.curPageNum + 5 
            print("test33")
            if lastPageNum > pageInfo.endPageNum:
                lastPageNum = pageInfo.endPageNum
            firstPageNum = lastPageNum - 9
            if firstPageNum < 1:
                firstPageNum = 1
        elif pageInfo.curPageNum == firstPageNum:  # and pageInfo.curPageNum != 1:
            firstPageNum = pageInfo.curPageNum - 5
            if firstPageNum < 1:
                firstPageNum = 1
            lastPageNum = firstPageNum + 9
        elif pageInfo.curPageNum == 1:
            firstPageNum = 1
            lastPageNum = 10
            if lastPageNum > pageInfo.endPageNum:
                lastPageNum = pageInfo.endPageNum
        elif pageInfo.curPageNum == pageInfo.endPageNum:
            lastPageNum = pageInfo.endPageNum
            firstPageNum = pageInfo.curPageNum - 9
            if firstPageNum < 1:
                firstPageNum = 1
        pageInfo.page = firstPageNum
        pageInfo.pages = range(firstPageNum, lastPageNum + 1)
        pageInfo.firstPageNum = firstPageNum
        print("test4")
        print(pageInfo.curIndex)
        print(pageInfo.endIndex)
        return pageInfo        
    except Exception as e:
        errors.append(e)
        return render_to_response('search_results.html', {'errors': errors})
        
def addVulnerability(req):
    if '_save' in req.GET: 
        return add_Save(req)
    else:
         return render_to_response('add_vuln.html')
     
def editVulnerability(req):
    if 'q' in req.GET:
        q = req.GET['q']
        vulnerability = CVE.objects.get(cve_id=q)
        return render_to_response('edit_vuln.html', {'vulnerability':vulnerability})
    elif '_update' in req.GET:
        cve_id = req.GET['cve_id']
        vulnerability = CVE.objects.get(cve_id=cve_id)
        vulnerability.cve_id = req.GET['cve_id']
        vulnerability.cwe_id = req.GET['cwe_id']
        vulnerability.vuln_type = req.GET['vuln_type']
        vulnerability.cvss_id = req.GET['cvss_id']
        vulnerability.description = req.GET['description']
        vulnerability.user = req.GET['user']
        vulnerability.save()
        return render_to_response("success.html")
    else:
        return render_to_response('edit_vuln.html')
